@using System;
@using System.Net;
@using misfits_festival.Shared.Models;
@using Dapper;
@using Npgsql;
@using misfits_festival.Client.Services;
@using misfits_festival.Client.Pages;
@using System.Net.Http;

@page "/nyvagt"

<h3>Opret ny vagt</h3>

<div class="parent">
    <div class="opretvagt">
        <EditForm EditContext="@EditContext" class="row p-3"> <!--Form til opretning af en ny vagt-->

            <div class="col-md-6 mb-3">
                <label for="OpgaveBeskrivelse">Opgave Beskrivelse</label>
                <InputText id="OpgaveBeskrivelse" @bind-Value="Vagt.OpgaveBeskrivelse" class="form-control" />
            </div>

            <br />

            <div class="col-md-6 mb-3">
                <label for="Dato">Dato</label>
                <InputDate id="Dato" @bind-Value="Vagt.Dato" class="form-control" />
            </div>

            <br />

            <div class="col-md-6 mb-3">
                <label for="VagtStart">Vagt start</label>
                <InputText id="VagtStart" @bind-Value="Vagt.VagtStart" class="form-control" />
            </div>

            <div class="col-md-6 mb-3">
                <label for="VagtSlut">Vagt slut</label>
                <InputText id="VagtSlut" @bind-Value="Vagt.VagtSlut" class="form-control" />
            </div>

            <div class="col-md-6 mb-3">
                <label for="Pause">Pause</label>
                <InputNumber id="Pause" @bind-Value="Vagt.Pause" class="form-control" />
            </div>

            <div class="col-md-6 mb-3">
                <label for="Område">Område</label>
                <InputText id="Område" @bind-Value="Vagt.Område" class="form-control" />
            </div>

            <br />

            <div class="col-12 mb-3">
                <button class="btn btn-primary" @onclick="AddVagtHandler">Tilføj ny vagt</button>
            </div>



        </EditForm>
    </div>
    <div class="opgaver">

        <table>
            <tr>
                <th>Opgave ID</th>
                <th>Opgave beskrivelse</th>
                <th></th>
            </tr>
            @foreach (var opgave in Opgaver)
            {
                <tr>
                    <td>@opgave.OpgaveId</td>
                    <td>@opgave.OpgaveBeskrivelse</td>
                    <!--De to knapper nedenfor bruges hhv. til valg af opgave når man laver en ny vagt, samt valg af opgave
                        til sletning af en opgave-->
                    <button class="btn btn-success" @onclick="() => VælgOpgave(opgave)">Vælg denne opgave</button>
                    <button class="btn btn-danger" @onclick="() => SletOpgaveKnap(opgave.OpgaveId)">Slet denne opgave</button>
                </tr>

            }
        </table>

        <br />

        <div class="col-md-12 mb-3">
            <label for="OpgaveAdd">Ny opgave</label>
            <input id="OpgaveAdd" @bind-value="Opgave.OpgaveBeskrivelse" class="form-control" />
            <button class="btn btn-primary" @onclick="AddOpgaveHandler">Tilføj denne opgave</button>
        </div>

        <div class="col-md-12 mb-3">
            <label for="OpgaveSlet">Slet opgave</label>
            <input id="OpgaveSlet" @bind-value="@SlettetOpgave.OpgaveId" class="form-control" />
            <button class="btn btn-primary" @onclick="() => DeleteOpgaveHandler(SlettetOpgave.OpgaveId)">Slet denne opgave</button>
        </div>
        
    </div>

</div>

@code {
    private EditContext EditContext;
    // private EditContext EditOpgaveContext;
    private Vagt Vagt = new Vagt();
    private List<Opgave> Opgaver = new List<Opgave>();
    private Opgave Opgave = new Opgave();
    private Opgave SlettetOpgave = new Opgave();

    private int ErrorCode { get; set; }

    // interfaces der tages i brug i dette component
    [Inject]
    public IVagtService VagtService { get; set; }
    [Inject]
    public IOpgaveService OpgaveService { get; set; }


    protected override void OnInitialized()
    {
        EditContext = new EditContext(Vagt);
    }

    private async Task AddVagtHandler()
    {
        ErrorCode = await VagtService.AddVagt(Vagt);
        Console.WriteLine("Vagt tilføjet: " + ErrorCode);
        Vagt = new Vagt();
        EditContext = new EditContext(Vagt);
    }

    private async Task AddOpgaveHandler()
    {
        ErrorCode = await OpgaveService.AddOpgave(Opgave);
        Console.WriteLine("Opgave tilføjet: " + ErrorCode);
        Opgave = new Opgave();
    }


    private async void DeleteOpgaveHandler(int? opgaveId)
    {
        ErrorCode = await OpgaveService.DeleteOpgave(SlettetOpgave.OpgaveId);
        OpgaveService.DeleteOpgave(SlettetOpgave.OpgaveId);
        Console.WriteLine("Opgave slettet: " + ErrorCode);
        Opgave = new Opgave();
    }


    protected override async Task OnInitializedAsync()
    {
        Opgaver = (await OpgaveService.GetAlleOpgaver()).ToList();
    }

    private async Task VælgOpgave(Opgave opgave)
    {
        // Vagt.OpgaveId = opgave.OpgaveId;
        Vagt.OpgaveId = opgave.OpgaveId; // fortæller hvilket specifikt id der skal vælges
        Vagt.OpgaveBeskrivelse = opgave.OpgaveBeskrivelse;
    }

    private async Task SletOpgaveKnap(int? opgaveId) // lav om til opgaveId og prøv metoderne igen
    {
        SlettetOpgave.OpgaveId = opgaveId; // fortæller hvilket specifikt id der skal slettes
        // SlettetOpgave.OpgaveBeskrivelse = opgave.OpgaveBeskrivelse;
    }

}
